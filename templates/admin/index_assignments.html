{% extends "admin/base.html" %}

{% block title %}Index Range Assignments - Admin Panel{% endblock %}

{% block content %}
<div class="content-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2 class="mb-2">Index Range Assignments</h2>
            <p class="text-muted mb-0">Assign exam rooms based on student index number ranges</p>
        </div>
        <div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAssignmentModal">
                <i class="fas fa-plus me-2"></i>Create Assignment
            </button>
        </div>
    </div>
</div>

<!-- Current Assignments -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-door-open me-2"></i>Current Assignments
                </h5>
            </div>
            <div class="card-body">
                {% if assignments %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Exam Session</th>
                                <th>Room</th>
                                <th>Building</th>
                                <th>Index Range</th>
                                <th>College</th>
                                <th>Department</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignment in assignments %}
                            <tr>
                                <td>
                                    <strong>{{ assignment.exam_title }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{ assignment.room_number }}</span>
                                </td>
                                <td>{{ assignment.building }}</td>
                                <td>
                                    <code class="bg-light px-2 py-1 rounded">
                                        {{ assignment.start_index }} - {{ assignment.end_index }}
                                    </code>
                                </td>
                                <td>
                                    {% if assignment.college_name %}
                                        {{ assignment.college_name }}
                                    {% else %}
                                        <span class="text-muted">All Colleges</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if assignment.department_name %}
                                        {{ assignment.department_name }}
                                    {% else %}
                                        <span class="text-muted">All Departments</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ assignment.created_at.strftime('%b %d, %Y') if assignment.created_at else 'N/A' }}
                                    </small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-warning" 
                                                onclick="editAssignment({{ assignment.id }})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" 
                                                onclick="deleteAssignment({{ assignment.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-door-open fa-4x text-muted mb-3"></i>
                    <h5 class="text-muted">No Room Assignments</h5>
                    <p class="text-muted mb-4">Create assignments to automatically assign students to exam rooms based on their index numbers</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAssignmentModal">
                        <i class="fas fa-plus me-2"></i>Create First Assignment
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Assignment Instructions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>How Index Range Assignments Work
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Example Assignment:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i>Exam: Mathematics Final</li>
                            <li><i class="fas fa-check text-success me-2"></i>Room: SF26</li>
                            <li><i class="fas fa-check text-success me-2"></i>Index Range: 8550000 - 8559999</li>
                        </ul>
                        <p class="text-muted">Students with index numbers like <code>8552721</code> will be automatically assigned to Room SF26.</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Assignment Rules:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-arrow-right text-primary me-2"></i>Index ranges should not overlap</li>
                            <li><i class="fas fa-arrow-right text-primary me-2"></i>Use numeric ranges (e.g., 8550000-8559999)</li>
                            <li><i class="fas fa-arrow-right text-primary me-2"></i>Consider room capacity when assigning ranges</li>
                            <li><i class="fas fa-arrow-right text-primary me-2"></i>Assignments are applied during face verification</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Assignment Modal -->
<div class="modal fade" id="addAssignmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-door-open me-2"></i>Create Index Range Assignment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="exam_session_id" class="form-label">Exam Session *</label>
                                <select class="form-control" name="exam_session_id" required>
                                    <option value="">Select Exam Session</option>
                                    {% for session in exam_sessions %}
                                    <option value="{{ session.id }}">
                                        {{ session.title }} - {{ session.exam_date }}
                                        {% if session.room_number %} ({{ session.room_number }}){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="room_id" class="form-label">Exam Room *</label>
                                <select class="form-control" name="room_id" required>
                                    <option value="">Select Room</option>
                                    {% for room in rooms %}
                                    <option value="{{ room.id }}">
                                        {{ room.room_number }} - {{ room.building }} (Capacity: {{ room.capacity }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="start_index" class="form-label">Start Index Number *</label>
                                <input type="text" class="form-control" name="start_index" required 
                                       placeholder="e.g., 8550000">
                                <div class="form-text">Starting index number for this range</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="end_index" class="form-label">End Index Number *</label>
                                <input type="text" class="form-control" name="end_index" required 
                                       placeholder="e.g., 8559999">
                                <div class="form-text">Ending index number for this range</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="college_id" class="form-label">College (Optional)</label>
                                <select class="form-control" name="college_id">
                                    <option value="">All Colleges</option>
                                    <!-- College options would be populated here -->
                                </select>
                                <div class="form-text">Leave empty to apply to all colleges</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="department_id" class="form-label">Department (Optional)</label>
                                <select class="form-control" name="department_id">
                                    <option value="">All Departments</option>
                                    <!-- Department options would be populated here -->
                                </select>
                                <div class="form-text">Leave empty to apply to all departments</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Important Notes:</h6>
                        <ul class="mb-0">
                            <li>Make sure index ranges don't overlap with existing assignments</li>
                            <li>Consider room capacity when defining ranges</li>
                            <li>Students will be automatically assigned during face verification</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Create Assignment
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script>
function editAssignment(assignmentId) {
    alert('Edit functionality would open a form to modify assignment ID: ' + assignmentId);
}

function deleteAssignment(assignmentId) {
    if (confirm('Are you sure you want to delete this assignment? Students will no longer be automatically assigned to this room.')) {
        alert('Assignment would be deleted: ' + assignmentId);
        location.reload();
    }
}

// Form validation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('#addAssignmentModal form');
    
    form.addEventListener('submit', function(e) {
        const startIndex = form.querySelector('input[name="start_index"]').value;
        const endIndex = form.querySelector('input[name="end_index"]').value;
        
        if (parseInt(startIndex) >= parseInt(endIndex)) {
            e.preventDefault();
            alert('End index must be greater than start index');
            return;
        }
        
        if (startIndex.length < 7 || endIndex.length < 7) {
            e.preventDefault();
            alert('Index numbers should be at least 7 digits long');
            return;
        }
    });
});
</script>
{% endblock %}
