<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Registration - Face Recognition System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .registration-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .video-container {
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            margin: 20px 0;
        }
        
        #video, #canvas {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 15px;
        }
        
        .btn-capture {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            color: white;
            font-weight: 600;
        }
        
        .btn-submit {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            color: white;
            font-weight: 600;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .navbar-brand, .nav-link {
            color: white !important;
        }
        
        .face-preview {
            border: 3px solid #28a745;
            border-radius: 15px;
            max-width: 300px;
            margin: 10px auto;
        }
        
        .face-detection-box {
            position: absolute;
            border: 3px solid #00ff00;
            border-radius: 5px;
            background: rgba(0, 255, 0, 0.1);
        }
        
        .detection-status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-graduation-cap me-2"></i>
                Student Face Recognition System
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link" href="/student/verify">Verify</a>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="registration-card p-5">
                    <div class="text-center mb-4">
                        <h2 class="text-primary mb-3">
                            <i class="fas fa-user-plus me-2"></i>
                            Student Registration
                        </h2>
                        <p class="text-muted">Register your academic details and capture your face for verification</p>
                    </div>

                    <form id="registrationForm">
                        <div class="row">
                            <!-- Personal Information -->
                            <div class="col-lg-6">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-user me-2"></i>Personal Information
                                </h5>
                                
                                <div class="mb-3">
                                    <label class="form-label">First Name *</label>
                                    <input type="text" class="form-control" name="first_name" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Middle Name</label>
                                    <input type="text" class="form-control" name="middle_name">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Last Name *</label>
                                    <input type="text" class="form-control" name="last_name" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Index Number *</label>
                                    <input type="text" class="form-control" name="index_number" required 
                                           placeholder="e.g., 8552721">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Email *</label>
                                    <input type="email" class="form-control" name="email" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" class="form-control" name="phone">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Date of Birth</label>
                                    <input type="date" class="form-control" name="date_of_birth">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Gender</label>
                                    <select class="form-control" name="gender">
                                        <option value="">Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Academic Information -->
                            <div class="col-lg-6">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-graduation-cap me-2"></i>Academic Information
                                </h5>
                                
                                <div class="mb-3">
                                    <label class="form-label">College *</label>
                                    <select class="form-control" name="college_id" id="collegeSelect" required>
                                        <option value="">Select College</option>
                                        {% for college in colleges %}
                                        <option value="{{ college.id }}">{{ college.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Department *</label>
                                    <select class="form-control" name="department_id" id="departmentSelect" required>
                                        <option value="">Select Department</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Year of Study *</label>
                                    <select class="form-control" name="year_of_study" required>
                                        <option value="">Select Year</option>
                                        <option value="1">1st Year</option>
                                        <option value="2">2nd Year</option>
                                        <option value="3">3rd Year</option>
                                        <option value="4">4th Year</option>
                                        <option value="5">5th Year</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Academic Year *</label>
                                    <select class="form-control" name="academic_year_id" required>
                                        <option value="">Select Academic Year</option>
                                        {% for year in academic_years %}
                                        <option value="{{ year.id }}" {% if year.is_current %}selected{% endif %}>
                                            {{ year.year_code }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Program/Course</label>
                                    <input type="text" class="form-control" name="program" 
                                           placeholder="e.g., Computer Science">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Address</label>
                                    <textarea class="form-control" name="address" rows="2"></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Emergency Contact</label>
                                    <input type="text" class="form-control" name="emergency_contact" 
                                           placeholder="Contact person name">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Emergency Phone</label>
                                    <input type="tel" class="form-control" name="emergency_phone">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Face Capture Section -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-camera me-2"></i>Face Capture
                                </h5>
                                
                                <div class="row">
                                    <div class="col-lg-6">
                                        <div class="video-container text-center">
                                            <video id="video" autoplay muted></video>
                                            <div class="detection-status" id="detectionStatus">
                                                <i class="fas fa-search me-1"></i>Looking for face...
                                            </div>
                                        </div>
                                        <div class="text-center mt-3">
                                            <button type="button" class="btn btn-capture" id="captureBtn">
                                                <i class="fas fa-camera me-2"></i>Capture Face
                                            </button>
                                            <button type="button" class="btn btn-secondary ms-2" id="retakeBtn" style="display: none;">
                                                <i class="fas fa-redo me-2"></i>Retake
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="col-lg-6">
                                        <div id="capturePreview" style="display: none;">
                                            <h6 class="text-center mb-3">Captured Image:</h6>
                                            <div class="text-center">
                                                <canvas id="canvas" class="face-preview"></canvas>
                                            </div>
                                        </div>
                                        
                                        <div id="captureInstructions" class="alert alert-info">
                                            <h6><i class="fas fa-info-circle me-2"></i>Face Capture Instructions:</h6>
                                            <ul class="mb-0">
                                                <li>Ensure good lighting on your face</li>
                                                <li>Look directly at the camera</li>
                                                <li>Keep your face within the detection box</li>
                                                <li>Remove glasses if possible</li>
                                                <li>Maintain a neutral expression</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-submit" id="submitBtn" disabled>
                                <i class="fas fa-user-plus me-2"></i>Register Student
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5>Processing Registration...</h5>
                    <p class="text-muted mb-0">Please wait while we save your information</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Face API.js for dynamic face detection (using local files) -->
    <script src="/static/js/face-api/face-api.min.js"></script>
    <script>
        let video, canvas, ctx;
        let capturedImageData = null;
        let faceDetectionInterval;
        let faceApiLoaded = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            
            console.log('DOM content loaded, initializing face detection system...');
            
            // Load face-api.js models first
            loadFaceApiModels().then(() => {
                console.log('Face API models successfully loaded, initializing camera...');
                faceApiLoaded = true;
                initializeCamera();
            }).catch(err => {
                console.error('Failed to load Face API models:', err);
                alert('Face detection could not be initialized. You may still capture your image manually.');
                // Still initialize camera as fallback
                initializeCamera();
            });
            
            // College selection change handler
            document.getElementById('collegeSelect').addEventListener('change', function() {
                const collegeId = this.value;
                const departmentSelect = document.getElementById('departmentSelect');
                
                // Clear existing options
                departmentSelect.innerHTML = '<option value="">Select Department</option>';
                
                if (collegeId) {
                    fetch(`/api/departments/${collegeId}`)
                        .then(response => response.json())
                        .then(departments => {
                            departments.forEach(dept => {
                                const option = document.createElement('option');
                                option.value = dept.id;
                                option.textContent = dept.name;
                                departmentSelect.appendChild(option);
                            });
                        })
                        .catch(error => {
                            console.error('Error loading departments:', error);
                        });
                }
            });
            
            // Capture button handler
            document.getElementById('captureBtn').addEventListener('click', captureImage);
            
            // Retake button handler
            document.getElementById('retakeBtn').addEventListener('click', function() {
                capturedImageData = null;
                document.getElementById('capturePreview').style.display = 'none';
                document.getElementById('captureBtn').style.display = 'inline-block';
                this.style.display = 'none';
                document.getElementById('submitBtn').disabled = true;
                video.style.display = 'block';
                startFaceDetection();
            });
            
            // Form submission handler
            document.getElementById('registrationForm').addEventListener('submit', submitRegistration);
        });
        
        async function loadFaceApiModels() {
            try {
                console.log('Loading face-api.js models...');
                const MODEL_URL = '/static/js/face-api/weights';
                
                // Try to load models with timeout
                const loadPromises = [
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ];
                
                await Promise.race([
                    Promise.all(loadPromises),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 20000))  // Increased timeout to 20 seconds
                ]);
                
                console.log('Face API models loaded successfully');
                return true;
            } catch (error) {
                console.error('Error loading Face API models:', error);
                console.log('Falling back to basic detection');
                return false;
            }
        }
        
        function initializeCamera() {
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: 640, 
                    height: 480,
                    facingMode: 'user'
                } 
            })
            .then(stream => {
                video.srcObject = stream;
                video.addEventListener('loadedmetadata', () => {
                    console.log('Camera initialized with dimensions:', video.videoWidth, 'x', video.videoHeight);
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    startFaceDetection();
                });
            })
            .catch(err => {
                console.error('Error accessing camera:', err);
                document.getElementById('detectionStatus').innerHTML = 
                    '<i class="fas fa-exclamation-triangle me-1"></i>Camera access denied';
                // Attempt to recover by using a more basic approach
                document.getElementById('captureBtn').disabled = false;
            });
        }
        
        function startFaceDetection() {
            clearInterval(faceDetectionInterval);
            
            // Create overlay canvas for face detection visualization
            let overlay = document.getElementById('faceOverlay');
            if (!overlay) {
                overlay = document.createElement('canvas');
                overlay.id = 'faceOverlay';
                overlay.style.position = 'absolute';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.pointerEvents = 'none';
                overlay.style.borderRadius = '15px';
                video.parentNode.style.position = 'relative';
                video.parentNode.appendChild(overlay);
            }
            
            const overlayCtx = overlay.getContext('2d');
            
            faceDetectionInterval = setInterval(async () => {
                if (video.videoWidth > 0 && video.videoHeight > 0) {
                    // Set overlay size to match video display
                    overlay.width = video.offsetWidth;
                    overlay.height = video.offsetHeight;
                    
                    // Clear previous detections
                    overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
                    
                    const status = document.getElementById('detectionStatus');
                    
                    if (faceApiLoaded && typeof faceapi !== 'undefined') {
                        try {
                            // Use face-api.js for advanced detection
                            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({
                                inputSize: 416,
                                scoreThreshold: 0.5
                            })).withFaceLandmarks();
                            
                            if (detections.length > 0) {
                                // Face detected
                                status.innerHTML = '<i class="fas fa-check-circle me-1"></i>Face detected - Ready to capture';
                                status.style.background = 'rgba(40, 167, 69, 0.8)';
                                
                                // Draw bounding boxes and landmarks
                                const scaleX = overlay.width / video.videoWidth;
                                const scaleY = overlay.height / video.videoHeight;
                                
                                detections.forEach(detection => {
                                    const { x, y, width, height } = detection.detection.box;
                                    
                                    // Draw dynamic face bounding box
                                    overlayCtx.strokeStyle = '#00ff00';
                                    overlayCtx.lineWidth = 3;
                                    overlayCtx.strokeRect(
                                        x * scaleX,
                                        y * scaleY,
                                        width * scaleX,
                                        height * scaleY
                                    );
                                    
                                    // Draw corner indicators
                                    const cornerSize = 20;
                                    overlayCtx.lineWidth = 4;
                                    
                                    // Top-left corner
                                    overlayCtx.beginPath();
                                    overlayCtx.moveTo(x * scaleX, y * scaleY + cornerSize);
                                    overlayCtx.lineTo(x * scaleX, y * scaleY);
                                    overlayCtx.lineTo(x * scaleX + cornerSize, y * scaleY);
                                    overlayCtx.stroke();
                                    
                                    // Top-right corner
                                    overlayCtx.beginPath();
                                    overlayCtx.moveTo((x + width) * scaleX - cornerSize, y * scaleY);
                                    overlayCtx.lineTo((x + width) * scaleX, y * scaleY);
                                    overlayCtx.lineTo((x + width) * scaleX, y * scaleY + cornerSize);
                                    overlayCtx.stroke();
                                    
                                    // Bottom-left corner
                                    overlayCtx.beginPath();
                                    overlayCtx.moveTo(x * scaleX, (y + height) * scaleY - cornerSize);
                                    overlayCtx.lineTo(x * scaleX, (y + height) * scaleY);
                                    overlayCtx.lineTo(x * scaleX + cornerSize, (y + height) * scaleY);
                                    overlayCtx.stroke();
                                    
                                    // Bottom-right corner
                                    overlayCtx.beginPath();
                                    overlayCtx.moveTo((x + width) * scaleX - cornerSize, (y + height) * scaleY);
                                    overlayCtx.lineTo((x + width) * scaleX, (y + height) * scaleY);
                                    overlayCtx.lineTo((x + width) * scaleX, (y + height) * scaleY - cornerSize);
                                    overlayCtx.stroke();
                                    
                                    // Add confidence and instruction text
                                    overlayCtx.fillStyle = '#00ff00';
                                    overlayCtx.font = 'bold 16px Arial';
                                    overlayCtx.fillText(
                                        `Confidence: ${(detection.detection.score * 100).toFixed(1)}%`,
                                        x * scaleX,
                                        y * scaleY - 25
                                    );
                                    
                                    overlayCtx.fillStyle = '#ffffff';
                                    overlayCtx.font = 'bold 14px Arial';
                                    overlayCtx.fillText(
                                        'Position your face in the center',
                                        x * scaleX,
                                        (y + height) * scaleY + 20
                                    );
                                });
                                
                            } else {
                                drawGuidanceBox(overlayCtx, overlay, status, false);
                            }
                            
                        } catch (error) {
                            console.error('Face detection error:', error);
                            // Fall back to basic detection
                            basicFaceDetectionForRegistration(overlayCtx, overlay, status);
                        }
                    } else {
                        // Use basic detection as fallback
                        basicFaceDetectionForRegistration(overlayCtx, overlay, status);
                    }
                }
            }, 150); // Update every 150ms for smooth detection
        }
        
        function basicFaceDetectionForRegistration(overlayCtx, overlay, status) {
            // Use simple heuristic: check if there's enough contrast in the center area
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 100;
            canvas.height = 100;
            
            // Draw a small portion of the video to analyze
            ctx.drawImage(video, 
                video.videoWidth * 0.3, video.videoHeight * 0.2, 
                video.videoWidth * 0.4, video.videoHeight * 0.5,
                0, 0, 100, 100
            );
            
            const imageData = ctx.getImageData(0, 0, 100, 100);
            const data = imageData.data;
            
            // Calculate variance in grayscale values (face detection heuristic)
            let sum = 0, sumSquares = 0;
            for (let i = 0; i < data.length; i += 4) {
                const gray = (data[i] + data[i + 1] + data[i + 2]) / 3;
                sum += gray;
                sumSquares += gray * gray;
            }
            
            const mean = sum / (data.length / 4);
            const variance = (sumSquares / (data.length / 4)) - (mean * mean);
            
            // If variance is high enough, assume face is present
            if (variance > 500) { // Threshold for face detection
                status.innerHTML = '<i class="fas fa-check-circle me-1"></i>Face detected - Ready to capture';
                status.style.background = 'rgba(40, 167, 69, 0.8)';
                
                // Draw basic face indication
                const centerX = overlay.width / 2;
                const centerY = overlay.height / 2;
                const faceWidth = overlay.width * 0.4;
                const faceHeight = overlay.height * 0.5;
                
                overlayCtx.strokeStyle = '#00ff00';
                overlayCtx.lineWidth = 3;
                overlayCtx.strokeRect(
                    centerX - faceWidth / 2,
                    centerY - faceHeight / 2,
                    faceWidth,
                    faceHeight
                );
                
                // Add text
                overlayCtx.fillStyle = '#00ff00';
                overlayCtx.font = 'bold 16px Arial';
                overlayCtx.textAlign = 'center';
                overlayCtx.fillText('Face Detected (Basic)', centerX, centerY - faceHeight / 2 - 10);
                overlayCtx.textAlign = 'left';
                
            } else {
                drawGuidanceBox(overlayCtx, overlay, status, true);
            }
        }
        
        function drawGuidanceBox(overlayCtx, overlay, status, isBasic) {
            // No face detected
            status.innerHTML = '<i class="fas fa-search me-1"></i>Position your face in the camera';
            status.style.background = 'rgba(255, 193, 7, 0.8)';
            
            // Draw guide box
            overlayCtx.strokeStyle = '#ffc107';
            overlayCtx.lineWidth = 2;
            overlayCtx.setLineDash([10, 5]);
            
            const guideWidth = overlay.width * 0.4;
            const guideHeight = overlay.height * 0.5;
            const guideX = (overlay.width - guideWidth) / 2;
            const guideY = (overlay.height - guideHeight) / 2;
            
            overlayCtx.strokeRect(guideX, guideY, guideWidth, guideHeight);
            overlayCtx.setLineDash([]);
            
            // Guide text
            overlayCtx.fillStyle = '#ffc107';
            overlayCtx.font = 'bold 16px Arial';
            overlayCtx.textAlign = 'center';
            overlayCtx.fillText('Position your face here', overlay.width / 2, guideY - 10);
            
            if (isBasic) {
                overlayCtx.font = 'bold 12px Arial';
                overlayCtx.fillText('(Using basic detection)', overlay.width / 2, guideY + guideHeight + 25);
            }
            
            overlayCtx.textAlign = 'left';
        }
        
        function captureImage() {
            console.log('Capturing face image...');
            // Draw current video frame to canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Get image data
            capturedImageData = canvas.toDataURL('image/jpeg', 0.8);
            console.log('Image captured successfully');
            
            // Hide video and show preview
            video.style.display = 'none';
            document.getElementById('capturePreview').style.display = 'block';
            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('retakeBtn').style.display = 'inline-block';
            document.getElementById('submitBtn').disabled = false;
            
            // Stop face detection
            clearInterval(faceDetectionInterval);
            document.getElementById('detectionStatus').innerHTML = 
                '<i class="fas fa-check-circle me-1"></i>Face captured';
            document.getElementById('detectionStatus').style.background = 'rgba(40, 167, 69, 0.8)';
        }
        
        function submitRegistration(e) {
            e.preventDefault();
            
            if (!capturedImageData) {
                alert('Please capture your face image first');
                return;
            }
            
            // Show loading modal
            new bootstrap.Modal(document.getElementById('loadingModal')).show();
            
            // Prepare form data
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.face_image = capturedImageData;
            
            // Submit registration
            fetch('/student/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                // Hide loading modal
                bootstrap.Modal.getInstance(document.getElementById('loadingModal')).hide();
                
                if (result.success) {
                    alert('Registration successful! Your Student ID: ' + result.student_id);
                    window.location.href = '/student/verify';
                } else {
                    alert('Registration failed: ' + result.message);
                }
            })
            .catch(error => {
                // Hide loading modal
                bootstrap.Modal.getInstance(document.getElementById('loadingModal')).hide();
                console.error('Error:', error);
                alert('Registration failed. Please try again.');
            });
        }
    </script>
</body>
</html>
