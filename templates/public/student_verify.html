<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Verification - Face Recognition System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .verification-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .video-container {
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            margin: 20px 0;
        }
        
        #video {
            width: 100%;
            max-width: 500px;
            height: auto;
            border-radius: 15px;
        }
        
        .btn-verify {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .btn-verify:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.4);
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .navbar-brand, .nav-link {
            color: white !important;
        }
        
        .face-detection-box {
            position: absolute;
            border: 3px solid #00ff00;
            border-radius: 5px;
            background: rgba(0, 255, 0, 0.1);
        }
        
        .detection-status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .student-profile {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
        }
        
        .profile-photo {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 5px solid white;
            object-fit: cover;
            margin: 0 auto 20px;
            display: block;
        }
        
        .exam-room-badge {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            padding: 15px 25px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }
        
        .exam-room-badge h3 {
            margin: 0;
            font-size: 2rem;
            font-weight: bold;
        }
        
        .confidence-badge {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            padding: 10px 20px;
            display: inline-block;
            margin: 10px 0;
        }
        
        .verification-steps {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-graduation-cap me-2"></i>
                Student Face Recognition System
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link" href="/student/register">Register</a>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="verification-card p-5">
                    <div class="text-center mb-4">
                        <h2 class="text-primary mb-3">
                            <i class="fas fa-camera me-2"></i>
                            Face Verification
                        </h2>
                        <p class="text-muted">Verify your identity to check exam attendance and get room assignment</p>
                    </div>

                    <!-- Verification Section -->
                    <div id="verificationSection">
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="verification-steps text-white">
                                    <h5 class="mb-3">
                                        <i class="fas fa-list-check me-2"></i>Verification Steps
                                    </h5>
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <span>Position your face in the camera view</span>
                                    </div>
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <span>Ensure good lighting</span>
                                    </div>
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <span>Look directly at the camera</span>
                                    </div>
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-clock text-warning me-2"></i>
                                        <span>Click verify when ready</span>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle me-2"></i>What happens next?</h6>
                                    <ul class="mb-0">
                                        <li>Your face will be matched against registered students</li>
                                        <li>Your profile and exam details will be displayed</li>
                                        <li>Your exam room will be assigned based on your index number</li>
                                        <li>Your attendance will be automatically marked</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="col-lg-6">
                                <div class="video-container text-center">
                                    <video id="video" autoplay muted></video>
                                    <div class="detection-status" id="detectionStatus">
                                        <i class="fas fa-search me-1"></i>Initializing camera...
                                    </div>
                                </div>
                                
                                <div class="text-center mt-3">
                                    <button type="button" class="btn btn-verify" id="verifyBtn">
                                        <i class="fas fa-check-circle me-2"></i>Verify Identity
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Student Profile Section (Hidden initially) -->
                    <div id="studentProfile" style="display: none;">
                        <div class="student-profile">
                            <div class="row">
                                <div class="col-lg-4 text-center">
                                    <div id="studentPhoto"></div>
                                    <div class="confidence-badge">
                                        <i class="fas fa-chart-line me-2"></i>
                                        <span id="confidenceScore">95%</span> Match Confidence
                                    </div>
                                </div>
                                
                                <div class="col-lg-8">
                                    <h3 class="mb-3">
                                        <i class="fas fa-user-graduate me-2"></i>
                                        <span id="studentName">Student Name</span>
                                    </h3>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Index Number:</strong> <span id="indexNumber"></span></p>
                                            <p><strong>Student ID:</strong> <span id="studentId"></span></p>
                                            <p><strong>Email:</strong> <span id="studentEmail"></span></p>
                                            <p><strong>Year of Study:</strong> <span id="yearOfStudy"></span></p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>College:</strong> <span id="college"></span></p>
                                            <p><strong>Department:</strong> <span id="department"></span></p>
                                            <p><strong>Academic Year:</strong> <span id="academicYear"></span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Exam Room Assignment -->
                            <div id="examRoomSection">
                                <div class="exam-room-badge">
                                    <h5 class="mb-2">
                                        <i class="fas fa-door-open me-2"></i>Exam Room Assignment
                                    </h5>
                                    <h3 id="examRoom">Room SF26</h3>
                                    <p class="mb-0" id="building">Science Building</p>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <i class="fas fa-book fa-2x mb-2"></i>
                                            <h6>Exam</h6>
                                            <p id="examTitle">Mathematics Final</p>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <i class="fas fa-calendar fa-2x mb-2"></i>
                                            <h6>Date</h6>
                                            <p id="examDate">2025-08-15</p>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <i class="fas fa-clock fa-2x mb-2"></i>
                                            <h6>Time</h6>
                                            <p id="examTime">09:00 - 12:00</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-success mt-3">
                                <h6><i class="fas fa-check-circle me-2"></i>Attendance Confirmed!</h6>
                                <p class="mb-0">Your exam attendance has been successfully recorded.</p>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button type="button" class="btn btn-secondary" onclick="resetVerification()">
                                <i class="fas fa-redo me-2"></i>Verify Another Student
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5>Verifying Identity...</h5>
                    <p class="text-muted mb-0">Please wait while we process your face data</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Face API.js for dynamic face detection -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script>
        let video;
        let faceDetectionInterval;
        let faceApiLoaded = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            video = document.getElementById('video');
            
            // Add debug logging
            console.log('Starting face detection system...');
            
            // Try to load face-api.js models first, but with aggressive timeout
            loadFaceApiModels().then((loaded) => {
                faceApiLoaded = loaded;
                console.log('Face API loaded:', loaded);
                initializeCamera();
            }).catch(() => {
                console.log('Face API loading failed, using basic detection');
                faceApiLoaded = false;
                initializeCamera();
            });
            
            // Verify button handler
            document.getElementById('verifyBtn').addEventListener('click', verifyIdentity);
        });
        
        async function loadFaceApiModels() {
            try {
                console.log('Loading face-api.js models...');
                
                // Check if faceapi is available
                if (typeof faceapi === 'undefined') {
                    console.log('face-api.js not loaded, using basic detection');
                    return false;
                }
                
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights';
                
                // Try to load models with aggressive timeout (5 seconds)
                const loadPromises = [
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ];
                
                await Promise.race([
                    Promise.all(loadPromises),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 5000))
                ]);
                
                console.log('Face API models loaded successfully');
                return true;
            } catch (error) {
                console.error('Error loading Face API models:', error);
                console.log('Falling back to basic detection');
                return false;
            }
        }
        
        function initializeCamera() {
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: 640, 
                    height: 480,
                    facingMode: 'user'
                } 
            })
            .then(stream => {
                video.srcObject = stream;
                video.addEventListener('loadedmetadata', () => {
                    startFaceDetection();
                });
            })
            .catch(err => {
                console.error('Error accessing camera:', err);
                document.getElementById('detectionStatus').innerHTML = 
                    '<i class="fas fa-exclamation-triangle me-1"></i>Camera access denied';
            });
        }
        
        function startFaceDetection() {
            clearInterval(faceDetectionInterval);
            console.log('Starting face detection with faceApiLoaded:', faceApiLoaded);
            
            // Create overlay canvas for face detection visualization
            let overlay = document.getElementById('faceOverlay');
            if (!overlay) {
                overlay = document.createElement('canvas');
                overlay.id = 'faceOverlay';
                overlay.style.position = 'absolute';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.pointerEvents = 'none';
                overlay.style.borderRadius = '15px';
                video.parentNode.style.position = 'relative';
                video.parentNode.appendChild(overlay);
            }
            
            const overlayCtx = overlay.getContext('2d');
            
            faceDetectionInterval = setInterval(async () => {
                if (video.videoWidth > 0 && video.videoHeight > 0) {
                    // Set overlay size to match video display
                    overlay.width = video.offsetWidth;
                    overlay.height = video.offsetHeight;
                    
                    // Clear previous detections
                    overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
                    
                    const status = document.getElementById('detectionStatus');
                    const verifyBtn = document.getElementById('verifyBtn');
                    
                    // Always enable verify button and use basic detection
                    // This ensures the system works even if face detection fails
                    verifyBtn.disabled = false;
                    status.innerHTML = '<i class="fas fa-check-circle me-1"></i>Camera ready - Click verify to proceed';
                    status.style.background = 'rgba(40, 167, 69, 0.8)';
                    
                    // Try advanced detection if available, but don't block on it
                    if (faceApiLoaded && typeof faceapi !== 'undefined') {
                        try {
                            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({
                                inputSize: 320,
                                scoreThreshold: 0.4
                            }));
                            
                            if (detections.length > 0) {
                                drawAdvancedFaceDetection(overlayCtx, detections, overlay, status, verifyBtn);
                            } else {
                                // Show basic ready state
                                drawBasicReadyState(overlayCtx, overlay, status, verifyBtn);
                            }
                            
                        } catch (error) {
                            console.warn('Advanced face detection error (continuing with basic):', error);
                            drawBasicReadyState(overlayCtx, overlay, status, verifyBtn);
                        }
                    } else {
                        // Use simple detection for better reliability
                        basicFaceDetection(overlayCtx, overlay, status, verifyBtn);
                    }
                }
            }, 200); // Slower update for better performance
        }
        
        function drawBasicReadyState(overlayCtx, overlay, status, verifyBtn) {
            // Always show ready state
            status.innerHTML = '<i class="fas fa-camera me-1"></i>Camera ready - Position your face and click verify';
            status.style.background = 'rgba(40, 167, 69, 0.8)';
            verifyBtn.disabled = false;
            
            // Draw simple guide frame
            const centerX = overlay.width / 2;
            const centerY = overlay.height / 2;
            const frameWidth = overlay.width * 0.6;
            const frameHeight = overlay.height * 0.7;
            
            overlayCtx.strokeStyle = '#28a745';
            overlayCtx.lineWidth = 2;
            overlayCtx.setLineDash([10, 5]);
            overlayCtx.strokeRect(
                centerX - frameWidth / 2,
                centerY - frameHeight / 2,
                frameWidth,
                frameHeight
            );
            overlayCtx.setLineDash([]);
            
            // Add instructions
            overlayCtx.fillStyle = '#ffffff';
            overlayCtx.font = 'bold 16px Arial';
            overlayCtx.strokeStyle = '#000000';
            overlayCtx.lineWidth = 3;
            overlayCtx.textAlign = 'center';
            
            overlayCtx.strokeText('Position your face here', centerX, centerY - frameHeight / 2 - 20);
            overlayCtx.fillText('Position your face here', centerX, centerY - frameHeight / 2 - 20);
            
            overlayCtx.font = 'bold 14px Arial';
            overlayCtx.strokeText('Click Verify when ready', centerX, centerY + frameHeight / 2 + 30);
            overlayCtx.fillText('Click Verify when ready', centerX, centerY + frameHeight / 2 + 30);
            
            overlayCtx.textAlign = 'left';
        }
        
        function drawAdvancedFaceDetection(overlayCtx, detections, overlay, status, verifyBtn) {
            // Face detected with face-api.js
            status.innerHTML = '<i class="fas fa-check-circle me-1"></i>Face detected - Ready to verify';
            status.style.background = 'rgba(40, 167, 69, 0.8)';
            verifyBtn.disabled = false;
            
            // Draw bounding boxes and landmarks
            const scaleX = overlay.width / video.videoWidth;
            const scaleY = overlay.height / video.videoHeight;
            
            detections.forEach(detection => {
                const { x, y, width, height } = detection.detection.box;
                
                // Draw dynamic face bounding box with modern styling
                overlayCtx.strokeStyle = '#28a745';
                overlayCtx.lineWidth = 3;
                
                // Draw animated scanning lines
                const time = Date.now() / 1000;
                const scanLineY = y * scaleY + (Math.sin(time * 2) * 0.5 + 0.5) * height * scaleY;
                
                overlayCtx.strokeRect(
                    x * scaleX,
                    y * scaleY,
                    width * scaleX,
                    height * scaleY
                );
                
                // Draw scanning line
                overlayCtx.strokeStyle = '#00ff00';
                overlayCtx.lineWidth = 2;
                overlayCtx.beginPath();
                overlayCtx.moveTo(x * scaleX, scanLineY);
                overlayCtx.lineTo((x + width) * scaleX, scanLineY);
                overlayCtx.stroke();
                
                // Draw corner indicators
                drawCornerIndicators(overlayCtx, x * scaleX, y * scaleY, width * scaleX, height * scaleY, time);
                
                // Add text
                overlayCtx.fillStyle = '#28a745';
                overlayCtx.font = 'bold 16px Arial';
                overlayCtx.fillText(
                    `Ready to verify (${(detection.detection.score * 100).toFixed(1)}%)`,
                    x * scaleX,
                    y * scaleY - 30
                );
            });
        }
        
        function basicFaceDetection(overlayCtx, overlay, status, verifyBtn) {
            // Use simple heuristic: check if there's enough contrast in the center area
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 100;
            canvas.height = 100;
            
            // Draw a small portion of the video to analyze
            ctx.drawImage(video, 
                video.videoWidth * 0.3, video.videoHeight * 0.2, 
                video.videoWidth * 0.4, video.videoHeight * 0.5,
                0, 0, 100, 100
            );
            
            const imageData = ctx.getImageData(0, 0, 100, 100);
            const data = imageData.data;
            
            // Calculate variance in grayscale values (face detection heuristic)
            let sum = 0, sumSquares = 0;
            for (let i = 0; i < data.length; i += 4) {
                const gray = (data[i] + data[i + 1] + data[i + 2]) / 3;
                sum += gray;
                sumSquares += gray * gray;
            }
            
            const mean = sum / (data.length / 4);
            const variance = (sumSquares / (data.length / 4)) - (mean * mean);
            
            // If variance is high enough, assume face is present
            if (variance > 500) { // Threshold for face detection
                status.innerHTML = '<i class="fas fa-check-circle me-1"></i>Face detected - Ready to verify';
                status.style.background = 'rgba(40, 167, 69, 0.8)';
                verifyBtn.disabled = false;
                
                // Draw basic face indication
                const centerX = overlay.width / 2;
                const centerY = overlay.height / 2;
                const faceWidth = overlay.width * 0.4;
                const faceHeight = overlay.height * 0.5;
                
                overlayCtx.strokeStyle = '#28a745';
                overlayCtx.lineWidth = 3;
                overlayCtx.strokeRect(
                    centerX - faceWidth / 2,
                    centerY - faceHeight / 2,
                    faceWidth,
                    faceHeight
                );
                
                // Add text
                overlayCtx.fillStyle = '#28a745';
                overlayCtx.font = 'bold 16px Arial';
                overlayCtx.textAlign = 'center';
                overlayCtx.fillText('Face Detected', centerX, centerY - faceHeight / 2 - 10);
                overlayCtx.textAlign = 'left';
                
            } else {
                drawGuidanceBox(overlayCtx, overlay, status, verifyBtn, true);
            }
        }
        
        function drawGuidanceBox(overlayCtx, overlay, status, verifyBtn, isBasic) {
            // No face detected
            status.innerHTML = '<i class="fas fa-search me-1"></i>Position your face in the camera';
            status.style.background = 'rgba(255, 193, 7, 0.8)';
            verifyBtn.disabled = true;
            
            // Draw guide box for face positioning
            overlayCtx.strokeStyle = '#ffc107';
            overlayCtx.lineWidth = 2;
            overlayCtx.setLineDash([15, 10]);
            
            const guideWidth = overlay.width * 0.5;
            const guideHeight = overlay.height * 0.6;
            const guideX = (overlay.width - guideWidth) / 2;
            const guideY = (overlay.height - guideHeight) / 2;
            
            overlayCtx.strokeRect(guideX, guideY, guideWidth, guideHeight);
            overlayCtx.setLineDash([]);
            
            // Guide text
            overlayCtx.fillStyle = '#ffc107';
            overlayCtx.font = 'bold 18px Arial';
            overlayCtx.strokeStyle = '#000000';
            overlayCtx.lineWidth = 2;
            overlayCtx.textAlign = 'center';
            
            overlayCtx.strokeText('Position your face here', overlay.width / 2, guideY - 15);
            overlayCtx.fillText('Position your face here', overlay.width / 2, guideY - 15);
            
            if (isBasic) {
                overlayCtx.font = 'bold 12px Arial';
                overlayCtx.strokeText('(Using basic detection)', overlay.width / 2, guideY + guideHeight + 35);
                overlayCtx.fillText('(Using basic detection)', overlay.width / 2, guideY + guideHeight + 35);
            }
            
            overlayCtx.textAlign = 'left';
        }
        
        function drawCornerIndicators(overlayCtx, x, y, width, height, time) {
            const cornerSize = 25;
            overlayCtx.strokeStyle = '#20c997';
            overlayCtx.lineWidth = 4;
            
            // Animated corner brackets
            const cornerOffset = Math.sin(time * 3) * 5;
            
            // Top-left corner
            overlayCtx.beginPath();
            overlayCtx.moveTo(x, y + cornerSize + cornerOffset);
            overlayCtx.lineTo(x, y);
            overlayCtx.lineTo(x + cornerSize + cornerOffset, y);
            overlayCtx.stroke();
            
            // Top-right corner
            overlayCtx.beginPath();
            overlayCtx.moveTo(x + width - cornerSize - cornerOffset, y);
            overlayCtx.lineTo(x + width, y);
            overlayCtx.lineTo(x + width, y + cornerSize + cornerOffset);
            overlayCtx.stroke();
            
            // Bottom-left corner
            overlayCtx.beginPath();
            overlayCtx.moveTo(x, y + height - cornerSize - cornerOffset);
            overlayCtx.lineTo(x, y + height);
            overlayCtx.lineTo(x + cornerSize + cornerOffset, y + height);
            overlayCtx.stroke();
            
            // Bottom-right corner
            overlayCtx.beginPath();
            overlayCtx.moveTo(x + width - cornerSize - cornerOffset, y + height);
            overlayCtx.lineTo(x + width, y + height);
            overlayCtx.lineTo(x + width, y + height - cornerSize - cornerOffset);
            overlayCtx.stroke();
        }
        
        function verifyIdentity() {
            // Show loading modal
            new bootstrap.Modal(document.getElementById('loadingModal')).show();
            
            // Capture current frame
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Submit for verification
            fetch('/student/verify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ face_image: imageData })
            })
            .then(response => response.json())
            .then(result => {
                // Hide loading modal
                bootstrap.Modal.getInstance(document.getElementById('loadingModal')).hide();
                
                if (result.success) {
                    displayStudentProfile(result.student, result.attendance_marked);
                } else {
                    alert('Verification failed: ' + result.message);
                }
            })
            .catch(error => {
                // Hide loading modal
                bootstrap.Modal.getInstance(document.getElementById('loadingModal')).hide();
                console.error('Error:', error);
                alert('Verification failed. Please try again.');
            });
        }
        
        function displayStudentProfile(student, attendanceMarked) {
            // Stop face detection
            clearInterval(faceDetectionInterval);
            
            // Hide verification section
            document.getElementById('verificationSection').style.display = 'none';
            
            // Populate student data
            document.getElementById('studentName').textContent = student.name;
            document.getElementById('indexNumber').textContent = student.index_number;
            document.getElementById('studentId').textContent = student.student_id;
            document.getElementById('studentEmail').textContent = student.email;
            document.getElementById('college').textContent = student.college;
            document.getElementById('department').textContent = student.department;
            document.getElementById('yearOfStudy').textContent = student.year_of_study + getOrdinalSuffix(student.year_of_study) + ' Year';
            document.getElementById('academicYear').textContent = student.academic_year;
            document.getElementById('confidenceScore').textContent = student.confidence + '%';
            
            // Exam room information
            if (student.exam_room && student.exam_room !== 'Not Assigned') {
                document.getElementById('examRoom').textContent = student.exam_room;
                document.getElementById('building').textContent = student.building;
                document.getElementById('examTitle').textContent = student.exam_title || 'Exam Session';
                document.getElementById('examDate').textContent = student.exam_date || 'TBD';
                document.getElementById('examTime').textContent = student.exam_time || 'TBD';
            } else {
                document.getElementById('examRoomSection').innerHTML = `
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>No Exam Room Assigned</h6>
                        <p class="mb-0">No active exam session found for your index number. Please contact admin.</p>
                    </div>
                `;
            }
            
            // Show student profile
            document.getElementById('studentProfile').style.display = 'block';
        }
        
        function getOrdinalSuffix(num) {
            const ones = num % 10;
            const tens = Math.floor(num / 10) % 10;
            if (tens === 1) return 'th';
            switch (ones) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }
        
        function resetVerification() {
            // Show verification section
            document.getElementById('verificationSection').style.display = 'block';
            
            // Hide student profile
            document.getElementById('studentProfile').style.display = 'none';
            
            // Restart face detection
            startFaceDetection();
        }
    </script>
</body>
</html>
