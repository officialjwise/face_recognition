{% extends "enhanced_base.html" %}

{% block title %}Add Student - Student Face Recognition System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 fw-bold">Add New Student</h1>
    <a href="{{ url_for('students_list') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to Students
    </a>
</div>

<form method="POST" enctype="multipart/form-data" id="addStudentForm">
    <div class="row">
        <!-- Student Information -->
        <div class="col-xl-8">
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user text-primary me-2"></i>
                        Student Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="student_id" class="form-label">Student ID *</label>
                            <input type="text" class="form-control" id="student_id" name="student_id" 
                                   required maxlength="8" pattern="[0-9]{8}"
                                   placeholder="e.g., 12345678">
                            <div class="form-text">8-digit student ID</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="index_number" class="form-label">Index Number *</label>
                            <input type="text" class="form-control" id="index_number" name="index_number" 
                                   required maxlength="7" pattern="[0-9]{7}"
                                   placeholder="e.g., 1234567">
                            <div class="form-text">7-digit index number</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="first_name" class="form-label">First Name *</label>
                            <input type="text" class="form-control" id="first_name" name="first_name" required>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="middle_name" class="form-label">Middle Name</label>
                            <input type="text" class="form-control" id="middle_name" name="middle_name">
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="last_name" class="form-label">Last Name *</label>
                            <input type="text" class="form-control" id="last_name" name="last_name" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="phone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="phone" name="phone">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="date_of_birth" class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" id="date_of_birth" name="date_of_birth">
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="gender" class="form-label">Gender</label>
                            <select class="form-control" id="gender" name="gender">
                                <option value="">Select Gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="address" class="form-label">Address</label>
                        <textarea class="form-control" id="address" name="address" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="emergency_contact" class="form-label">Emergency Contact Name</label>
                            <input type="text" class="form-control" id="emergency_contact" name="emergency_contact">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="emergency_phone" class="form-label">Emergency Contact Phone</label>
                            <input type="tel" class="form-control" id="emergency_phone" name="emergency_phone">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Academic Information -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-graduation-cap text-primary me-2"></i>
                        Academic Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="college_id" class="form-label">College *</label>
                            <select class="form-control" id="college_id" name="college_id" required>
                                <option value="">Select College</option>
                                {% for college in colleges %}
                                    <option value="{{ college.id }}">{{ college.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="department_id" class="form-label">Department</label>
                            <select class="form-control" id="department_id" name="department_id">
                                <option value="">Select Department</option>
                                {% for department in departments %}
                                    <option value="{{ department.id }}" data-college="{{ department.college_id }}">
                                        {{ department.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="program" class="form-label">Program/Course</label>
                            <input type="text" class="form-control" id="program" name="program" 
                                   placeholder="e.g., Computer Science">
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="year_of_study" class="form-label">Year of Study</label>
                            <select class="form-control" id="year_of_study" name="year_of_study">
                                <option value="">Select Year</option>
                                <option value="1">Year 1</option>
                                <option value="2">Year 2</option>
                                <option value="3">Year 3</option>
                                <option value="4">Year 4</option>
                                <option value="5">Year 5</option>
                                <option value="6">Year 6</option>
                            </select>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="admission_year" class="form-label">Admission Year</label>
                            <input type="number" class="form-control" id="admission_year" name="admission_year" 
                                   min="2000" max="2030" value="{{ current_year }}">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Photo Upload -->
        <div class="col-xl-4">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-camera text-primary me-2"></i>
                        Student Photo
                    </h5>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <div id="photo-preview" class="mb-3" style="display: none;">
                            <img id="preview-image" src="" alt="Preview" 
                                 class="img-fluid rounded" style="max-height: 300px;">
                        </div>
                        
                        <div id="upload-placeholder" class="border border-2 border-dashed rounded p-4 mb-3">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Upload Student Photo</h5>
                            <p class="text-muted">Drag & drop or click to select</p>
                        </div>
                    </div>
                    
                    <input type="file" class="form-control" id="photo" name="photo" 
                           accept="image/*" style="display: none;">
                    
                    <button type="button" class="btn btn-outline-primary me-2" 
                            onclick="document.getElementById('photo').click();">
                        <i class="fas fa-upload me-1"></i>Choose File
                    </button>
                    
                    <button type="button" class="btn btn-outline-success" id="cameraBtn">
                        <i class="fas fa-camera me-1"></i>Take Photo
                    </button>
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            Supported formats: JPG, PNG<br>
                            Max size: 5MB<br>
                            For best results, use a clear front-facing photo
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Submit Buttons -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-end gap-3">
                        <a href="{{ url_for('students_list') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                        <button type="button" class="btn btn-outline-primary" onclick="saveDraft()">
                            <i class="fas fa-save me-2"></i>Save Draft
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-user-plus me-2"></i>Add Student
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Camera Modal -->
<div class="modal fade" id="cameraModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Take Student Photo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="camera-container mb-3">
                    <video id="camera-video" width="100%" height="400" autoplay></video>
                    <canvas id="camera-canvas" style="display: none;"></canvas>
                </div>
                
                <div class="d-flex justify-content-center gap-3">
                    <button type="button" class="btn btn-success" id="captureBtn">
                        <i class="fas fa-camera me-2"></i>Capture Photo
                    </button>
                    <button type="button" class="btn btn-primary" id="retakeBtn" style="display: none;">
                        <i class="fas fa-redo me-2"></i>Retake
                    </button>
                    <button type="button" class="btn btn-outline-success" id="usePhotoBtn" style="display: none;">
                        <i class="fas fa-check me-2"></i>Use This Photo
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let cameraStream = null;

// File upload preview
document.getElementById('photo').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            showPhotoPreview(e.target.result);
        };
        reader.readAsDataURL(file);
    }
});

// College/Department filtering
document.getElementById('college_id').addEventListener('change', function() {
    const collegeId = this.value;
    const departmentSelect = document.getElementById('department_id');
    const options = departmentSelect.querySelectorAll('option');
    
    // Reset department selection
    departmentSelect.value = '';
    
    // Show/hide departments based on college
    options.forEach(option => {
        if (option.value === '') {
            option.style.display = 'block';
        } else {
            const optionCollegeId = option.getAttribute('data-college');
            option.style.display = (collegeId === '' || optionCollegeId === collegeId) ? 'block' : 'none';
        }
    });
});

// Camera functionality
document.getElementById('cameraBtn').addEventListener('click', function() {
    const modal = new bootstrap.Modal(document.getElementById('cameraModal'));
    modal.show();
    startCamera();
});

document.getElementById('captureBtn').addEventListener('click', capturePhoto);
document.getElementById('retakeBtn').addEventListener('click', retakePhoto);
document.getElementById('usePhotoBtn').addEventListener('click', usePhoto);

function startCamera() {
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            cameraStream = stream;
            document.getElementById('camera-video').srcObject = stream;
        })
        .catch(err => {
            console.error('Camera access denied:', err);
            alert('Camera access denied. Please allow camera access and try again.');
        });
}

function capturePhoto() {
    const video = document.getElementById('camera-video');
    const canvas = document.getElementById('camera-canvas');
    const context = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);
    
    video.style.display = 'none';
    canvas.style.display = 'block';
    
    document.getElementById('captureBtn').style.display = 'none';
    document.getElementById('retakeBtn').style.display = 'inline-block';
    document.getElementById('usePhotoBtn').style.display = 'inline-block';
}

function retakePhoto() {
    const video = document.getElementById('camera-video');
    const canvas = document.getElementById('camera-canvas');
    
    video.style.display = 'block';
    canvas.style.display = 'none';
    
    document.getElementById('captureBtn').style.display = 'inline-block';
    document.getElementById('retakeBtn').style.display = 'none';
    document.getElementById('usePhotoBtn').style.display = 'none';
}

function usePhoto() {
    const canvas = document.getElementById('camera-canvas');
    const dataURL = canvas.toDataURL('image/jpeg');
    
    showPhotoPreview(dataURL);
    
    // Convert to file and set to input
    canvas.toBlob(blob => {
        const file = new File([blob], 'camera_photo.jpg', { type: 'image/jpeg' });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        document.getElementById('photo').files = dataTransfer.files;
    });
    
    stopCamera();
    bootstrap.Modal.getInstance(document.getElementById('cameraModal')).hide();
}

function stopCamera() {
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
    }
}

function showPhotoPreview(src) {
    document.getElementById('preview-image').src = src;
    document.getElementById('photo-preview').style.display = 'block';
    document.getElementById('upload-placeholder').style.display = 'none';
}

function saveDraft() {
    // Implement save draft functionality
    alert('Draft saved! (This would save the form data locally)');
}

// Form validation
document.getElementById('addStudentForm').addEventListener('submit', function(e) {
    const studentId = document.getElementById('student_id').value;
    const indexNumber = document.getElementById('index_number').value;
    
    if (!/^\d{8}$/.test(studentId)) {
        e.preventDefault();
        alert('Student ID must be exactly 8 digits');
        return;
    }
    
    if (!/^\d{7}$/.test(indexNumber)) {
        e.preventDefault();
        alert('Index Number must be exactly 7 digits');
        return;
    }
});

// Clean up camera when modal is closed
document.getElementById('cameraModal').addEventListener('hidden.bs.modal', function() {
    stopCamera();
    retakePhoto(); // Reset camera view
});

// Set current year
document.getElementById('admission_year').value = new Date().getFullYear();
</script>
{% endblock %}
